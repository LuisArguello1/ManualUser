================================================================================
    SISTEMA DE GESTI√ìN VETERINARIA - MANUAL DE USUARIO
    PARTE 1: AUTENTICACI√ìN Y GESTI√ìN DE USUARIOS
================================================================================

FECHA: Noviembre 2025
VERSI√ìN: 1.0
PROP√ìSITO: Documentaci√≥n t√©cnica completa para desarrollo de manual de usuario


================================================================================
1. INTRODUCCI√ìN AL SISTEMA
================================================================================

El Sistema de Gesti√≥n Veterinaria es una plataforma web integral que combina:
- Gesti√≥n de usuarios con tres roles diferenciados
- Reconocimiento facial biom√©trico para autenticaci√≥n
- Registro y administraci√≥n de mascotas (caninos)
- Reconocimiento biom√©trico facial de mascotas
- Predicci√≥n de caracter√≠sticas mediante Inteligencia Artificial
- Sistema de alertas para mascotas perdidas
- Generaci√≥n de carnets y c√≥digos QR
- Esc√°ner de reconocimiento de mascotas
- Sistema de notificaciones interno


================================================================================
2. REGISTRO DE USUARIOS
================================================================================

2.1 PROCESO DE REGISTRO
------------------------
URL: /register/
M√©todo: Acceso libre (sin necesidad de autenticaci√≥n previa)

CAMPOS OBLIGATORIOS:
- Username (nombre de usuario √∫nico)
- Email (correo electr√≥nico √∫nico)
- Contrase√±a (m√≠nimo 8 caracteres)
- Confirmaci√≥n de contrase√±a
- Nombre completo (first_name + last_name)
- C√©dula (DNI - documento √∫nico de identificaci√≥n)

CAMPOS OPCIONALES:
- Foto de perfil
- Direcci√≥n
- Tel√©fono

ROL ASIGNADO:
Al registrarse, todos los usuarios reciben autom√°ticamente el rol "OWNER" (Due√±o de mascota)

CARACTER√çSTICAS DEL FORMULARIO:
‚úì Validaci√≥n en tiempo real del nombre de usuario
‚úì Validaci√≥n de formato de email
‚úì Verificaci√≥n de fortaleza de contrase√±a
‚úì Verificaci√≥n de coincidencia de contrase√±as
‚úì Icono de "ojo" para mostrar/ocultar contrase√±a
‚úì Mensajes de error descriptivos para cada campo
‚úì Prevenci√≥n de doble env√≠o del formulario (loading state)

VALIDACIONES DEL SISTEMA:
- Username: Debe ser √∫nico en el sistema
- Email: Debe ser √∫nico y tener formato v√°lido
- C√©dula: Debe ser √∫nica (10 d√≠gitos)
- Contrase√±a: M√≠nimo 8 caracteres, debe incluir letras y n√∫meros

RESULTADO EXITOSO:
- Usuario creado con rol OWNER
- Redirecci√≥n autom√°tica al login
- Mensaje de confirmaci√≥n: "Cuenta creada exitosamente. Por favor inicia sesi√≥n."


2.2 REGISTRO DE BIOMETR√çA FACIAL (POST-REGISTRO)
------------------------------------------------
URL: /facial-biometry/
Disponible despu√©s del primer login

PROP√ìSITO:
Permite al usuario registrar su rostro para autenticaci√≥n biom√©trica (opcional)

REQUISITOS:
‚úì Usuario debe estar autenticado
‚úì C√°mara web funcional
‚úì Buena iluminaci√≥n
‚úì Rostro visible de frente

PROCESO PASO A PASO:

1. ACCESO AL M√ìDULO:
   - Dashboard ‚Üí Perfil ‚Üí "Registrar Biometr√≠a Facial"
   - O directamente desde el men√∫ de perfil

2. CAPTURA DE ROSTRO:
   - El sistema activa la c√°mara web
   - Se muestra vista previa en tiempo real
   - Usuario debe posicionarse de frente
   - Presionar bot√≥n "Capturar Rostro"

3. VALIDACIONES AUTOM√ÅTICAS:
   El sistema verifica:
   ‚úì Detecci√≥n de rostro √∫nico (solo 1 persona en frame)
   ‚úì Calidad de imagen ‚â• 70% de confianza
   ‚úì Iluminaci√≥n adecuada
   ‚úì Nitidez suficiente
   ‚úì Rostro de frente (no de perfil)

4. PROCESAMIENTO CON IA:
   Tecnolog√≠a: ArcFace ResNet100 (99.77% precisi√≥n)
   - Detecci√≥n de rostro con YuNet
   - Identificaci√≥n de 5 puntos clave (landmarks):
     * Ojo izquierdo
     * Ojo derecho
     * Punta de la nariz
     * Comisura izquierda de la boca
     * Comisura derecha de la boca
   - Alineaci√≥n facial autom√°tica
   - Extracci√≥n de "descriptor facial" (embedding de 512 n√∫meros)
   - Normalizaci√≥n del vector
   - Almacenamiento seguro en base de datos

5. CONFIRMACI√ìN:
   - Mensaje: "Biometr√≠a facial registrada exitosamente"
   - Usuario ahora puede usar reconocimiento facial para login

L√çMITES Y RESTRICCIONES:
- Solo 1 rostro permitido por usuario
- Se puede eliminar y volver a registrar
- No funciona con fotos (debe ser persona real)
- Requiere condiciones m√≠nimas de calidad

MEDIDAS DE SEGURIDAD:
‚úì Rate limiting: 10 intentos por hora
‚úì Validaci√≥n de rostro √∫nico (anti-spoofing b√°sico)
‚úì Confianza m√≠nima del 70%
‚úì Encriptaci√≥n del descriptor facial


================================================================================
3. INICIO DE SESI√ìN (LOGIN)
================================================================================

3.1 LOGIN TRADICIONAL (EMAIL Y CONTRASE√ëA)
-------------------------------------------
URL: /login/
M√©todo: POST

CAMPOS:
- Email (obligatorio)
- Contrase√±a (obligatorio)

CARACTER√çSTICAS:
‚úì Icono de "ojo" para mostrar/ocultar contrase√±a
‚úì Validaci√≥n en tiempo real
‚úì Mensajes de error espec√≠ficos
‚úì Prevenci√≥n de doble env√≠o
‚úì Link a recuperaci√≥n de contrase√±a
‚úì Link a registro de nuevo usuario

VALIDACIONES:
- Email debe existir en el sistema
- Contrase√±a debe coincidir
- Usuario debe estar activo (is_active=True)

SISTEMA ANTI-DUPLICACI√ìN DE NOTIFICACIONES:
El sistema previene notificaciones duplicadas verificando:
- Si existe notificaci√≥n de login en los √∫ltimos 10 segundos
- Evita crear m√∫ltiples notificaciones por recargas accidentales

RESULTADO EXITOSO:
- Sesi√≥n iniciada
- Notificaci√≥n in-app: "Bienvenido de vuelta, [nombre]"
- Redirecci√≥n seg√∫n rol:
  * ADMIN ‚Üí /admin-dashboard/
  * OWNER/VET ‚Üí /dashboard/


3.2 LOGIN CON RECONOCIMIENTO FACIAL
-----------------------------------
URL: /facial-login/
M√©todo: Captura de imagen + POST

REQUISITOS PREVIOS:
‚úì Usuario debe haber registrado su biometr√≠a facial previamente
‚úì C√°mara web funcional
‚úì Buena iluminaci√≥n

PROCESO:

1. ACCESO A LA INTERFAZ:
   - P√°gina de login ‚Üí Bot√≥n "Iniciar sesi√≥n con reconocimiento facial"
   - Se abre interfaz de c√°mara

2. CAPTURA:
   - Sistema activa c√°mara web
   - Usuario se posiciona de frente
   - Sistema detecta rostro autom√°ticamente
   - Usuario presiona "Autenticar" o captura autom√°tica

3. PROCESAMIENTO:
   Tecnolog√≠a: ArcFace ResNet100
   - Detecci√≥n de rostro con YuNet
   - Extracci√≥n de descriptor facial (512 n√∫meros)
   - Comparaci√≥n con TODOS los descriptores en BD
   - C√°lculo de similitud coseno con cada usuario

4. VALIDACIONES:
   ‚úì Solo 1 rostro en la imagen
   ‚úì Calidad suficiente (‚â•70%)
   ‚úì Similitud ‚â• 40% con alg√∫n usuario registrado

5. DECISI√ìN:
   - Similitud ‚â• 0.40 (40%) ‚Üí LOGIN EXITOSO ‚úì
   - Similitud < 0.40 ‚Üí ACCESO DENEGADO ‚úó

UMBRAL DE ACEPTACI√ìN: 40%
Raz√≥n: Balance entre seguridad y usabilidad
- Minimiza falsos positivos (otra persona accede)
- Minimiza falsos negativos (te rechaza siendo t√∫)

SEGURIDAD:
‚úì Rate limiting: 10 intentos por minuto
‚úì Validaci√≥n de rostro √∫nico
‚úì No funciona con fotos o pantallas
‚úì Registro de intentos fallidos

RESULTADO EXITOSO:
- Login autom√°tico sin contrase√±a
- Notificaci√≥n: "Autenticaci√≥n facial exitosa"
- Registro de reconocimiento con timestamp
- Redirecci√≥n al dashboard

RESULTADO FALLIDO:
- Mensaje: "No se reconoci√≥ tu rostro. Usa tu contrase√±a."
- Registro del intento fallido
- Opci√≥n de volver al login tradicional


================================================================================
4. TIPOS DE USUARIOS Y ROLES
================================================================================

El sistema maneja 3 roles diferenciados con permisos espec√≠ficos:

4.1 ADMIN (ADMINISTRADOR)
-------------------------
C√≥digo interno: 'ADMIN'

PERMISOS COMPLETOS:
‚úì Acceso a dashboard administrativo especializado
‚úì Ver estad√≠sticas globales del sistema
‚úì Gestionar todos los usuarios (crear, editar, eliminar)
‚úì Ver lista completa de usuarios
‚úì Cambiar roles de usuarios
‚úì Acceder a todas las mascotas del sistema
‚úì Ver m√©tricas y reportes avanzados
‚úì Configurar par√°metros del sistema

DASHBOARD EXCLUSIVO (URL: /admin-dashboard/):
Muestra 9 gr√°ficos y 8 estad√≠sticas:

ESTAD√çSTICAS:
1. Total de mascotas registradas
2. Escaneos totales realizados
3. Total de usuarios activos
4. Tasa de √©xito de reconocimiento
5. Registros biom√©tricos activos
6. Mascotas reportadas como perdidas
7. Autenticaciones faciales de usuarios
8. Total de notificaciones generadas

GR√ÅFICOS:
1. TOP 10 razas m√°s registradas (gr√°fico de barras)
2. Escaneos diarios (√∫ltimos 30 d√≠as - l√≠nea)
3. Mascotas por etapa de vida (pie chart)
4. Distribuci√≥n de condici√≥n corporal (doughnut)
5. Registros mensuales de mascotas (barras)
6. Actividad por hora del d√≠a (l√≠nea)
7. Distribuci√≥n de roles de usuarios (pie)
8. Tasa de √©xito de reconocimiento (gauge)
9. Notificaciones por categor√≠a (barras horizontales)

MEN√ö EXCLUSIVO:
- Dashboard Admin
- Gesti√≥n de Usuarios

CARACTER√çSTICAS:
- Protegido con decorador @user_passes_test(is_admin)
- Redirige a /dashboard/ si no es admin
- Acceso completo a logs y auditor√≠a


4.2 VET (VETERINARIO)
---------------------
C√≥digo interno: 'VET'

CAMPOS ADICIONALES:
- specialization (Especializaci√≥n - ej: Cirug√≠a, Dermatolog√≠a)
- license_number (N√∫mero de licencia profesional)

PERMISOS:
‚úì Ver todas las mascotas del sistema
‚úì Acceder a informaci√≥n completa de cualquier mascota
‚úì Ver historiales m√©dicos
‚úì Agregar notas veterinarias
‚úì Acceder a scanner de reconocimiento
‚úì Registrar sus propias mascotas (m√°ximo 2)
‚úì Recibir notificaciones de mascotas perdidas

RESTRICCIONES:
‚úó No puede eliminar mascotas de otros usuarios
‚úó No puede editar informaci√≥n de mascotas ajenas
‚úó No puede gestionar usuarios
‚úó No accede a dashboard administrativo

USO T√çPICO:
- Consultorios veterinarios
- Identificaci√≥n r√°pida de mascotas
- Seguimiento de pacientes
- Respuesta a alertas de mascotas perdidas


4.3 OWNER (DUE√ëO DE MASCOTA)
----------------------------
C√≥digo interno: 'OWNER'
Rol predeterminado al registrarse

PERMISOS:
‚úì Registrar hasta 2 mascotas m√°ximo
‚úì Editar sus propias mascotas
‚úì Eliminar sus propias mascotas
‚úì Registrar biometr√≠a de sus mascotas
‚úì Eliminar biometr√≠a de sus mascotas
‚úì Reportar mascotas como perdidas
‚úì Generar c√≥digo QR de sus mascotas
‚úì Usar scanner para identificar mascotas
‚úì Reportar mascotas encontradas
‚úì Generar y descargar carnets
‚úì Ver informaci√≥n p√∫blica de otras mascotas (v√≠a QR)
‚úì Recibir notificaciones del sistema

RESTRICCIONES:
‚úó No puede ver mascotas de otros usuarios (solo en scanner)
‚úó No puede editar/eliminar mascotas ajenas
‚úó No puede gestionar usuarios
‚úó No accede a dashboard administrativo
‚úó L√çMITE ESTRICTO: Solo 2 mascotas por usuario

USO T√çPICO:
- Due√±os de mascotas dom√©sticas
- Registro y seguimiento de sus perros
- Sistema de localizaci√≥n si se pierden
- Generaci√≥n de identificaci√≥n (QR + carnet)


================================================================================
5. GESTI√ìN DE PERFIL DE USUARIO
================================================================================

5.1 VER PERFIL
--------------
URL: /profile/
Acceso: Solo usuario autenticado

INFORMACI√ìN MOSTRADA:
- Foto de perfil (o avatar predeterminado)
- Nombre completo
- Username
- Email
- C√©dula
- Direcci√≥n
- Tel√©fono
- Rol actual
- Fecha de registro
- Estado de biometr√≠a facial (registrada o no)

CAMPOS ESPEC√çFICOS POR ROL:

Para VET:
- Especializaci√≥n
- N√∫mero de licencia

ACCIONES DISPONIBLES:
‚úì Editar perfil
‚úì Cambiar contrase√±a
‚úì Registrar/Eliminar biometr√≠a facial
‚úì Cerrar sesi√≥n


5.2 EDITAR PERFIL
-----------------
URL: /profile/edit/
M√©todo: POST

CAMPOS EDITABLES:
- Foto de perfil (imagen)
- Nombre (first_name)
- Apellido (last_name)
- Email (debe seguir siendo √∫nico)
- C√©dula (debe seguir siendo √∫nica)
- Direcci√≥n
- Tel√©fono

PARA VETERINARIOS:
- Especializaci√≥n
- N√∫mero de licencia

CAMPOS NO EDITABLES:
‚úó Username (permanente)
‚úó Rol (solo administrador puede cambiar)
‚úó Fecha de registro

VALIDACIONES:
- Email √∫nico en el sistema
- C√©dula √∫nica en el sistema
- Formato de email v√°lido
- Tama√±o de imagen ‚â§ 5MB

RESULTADO:
- Mensaje: "Perfil actualizado exitosamente"
- Notificaci√≥n in-app de cambio
- Redirecci√≥n a vista de perfil


5.3 CAMBIAR CONTRASE√ëA
----------------------
URL: /profile/change-password/
M√©todo: POST

CAMPOS:
- Contrase√±a actual (verificaci√≥n)
- Nueva contrase√±a
- Confirmar nueva contrase√±a

VALIDACIONES:
‚úì Contrase√±a actual debe ser correcta
‚úì Nueva contrase√±a ‚â• 8 caracteres
‚úì Nueva contrase√±a debe incluir letras y n√∫meros
‚úì Confirmaci√≥n debe coincidir con nueva contrase√±a
‚úì Nueva contrase√±a debe ser diferente a la actual

SEGURIDAD:
- Contrase√±a hasheada con Django's PBKDF2
- No se almacena en texto plano
- Sesiones anteriores se invalidan
- Notificaci√≥n de cambio enviada

RESULTADO:
- Mensaje: "Contrase√±a cambiada exitosamente"
- Logout autom√°tico (debe iniciar sesi√≥n con nueva contrase√±a)


5.4 GESTI√ìN DE BIOMETR√çA FACIAL DEL USUARIO
-------------------------------------------

REGISTRAR BIOMETR√çA:
URL: /facial-biometry/
- Proceso descrito en secci√≥n 2.2

ELIMINAR BIOMETR√çA:
URL: /facial-biometry/delete/
M√©todo: POST

CONFIRMACI√ìN REQUERIDA:
- Modal de confirmaci√≥n antes de eliminar
- Advertencia: "Deber√°s volver a registrarla para usar login facial"

RESULTADO:
- Descriptor facial eliminado de BD
- Mensaje: "Biometr√≠a facial eliminada correctamente"
- Login facial deshabilitado
- Usuario debe usar login tradicional


================================================================================
6. RECUPERACI√ìN DE CONTRASE√ëA
================================================================================

URL: /password-reset/
Disponible sin autenticaci√≥n

PROCESO:

1. SOLICITUD:
   - Usuario ingresa su email
   - Sistema verifica que existe
   - Genera token √∫nico temporal

2. ENV√çO DE EMAIL:
   - Asunto: "Recuperaci√≥n de contrase√±a - Sistema Veterinaria"
   - Contiene enlace con token
   - Token v√°lido por 1 hora

3. RESTABLECIMIENTO:
   - Usuario hace clic en enlace
   - Ingresa nueva contrase√±a
   - Confirma nueva contrase√±a

4. CONFIRMACI√ìN:
   - Contrase√±a actualizada
   - Token invalidado
   - Mensaje: "Contrase√±a restablecida exitosamente"
   - Redirecci√≥n al login

SEGURIDAD:
‚úì Token √∫nico de un solo uso
‚úì Expiraci√≥n en 1 hora
‚úì Verificaci√≥n de email
‚úì Rate limiting de solicitudes


================================================================================
7. SISTEMA DE NOTIFICACIONES (IN-APP)
================================================================================

El sistema cuenta con un robusto sistema de notificaciones interno (NO por email, salvo excepciones espec√≠ficas)

7.1 TIPOS DE NOTIFICACIONES
---------------------------

POR NIVEL:
- INFO (azul): Informaci√≥n general
- SUCCESS (verde): Acciones exitosas
- WARNING (amarillo): Advertencias
- ERROR (rojo): Errores o alertas cr√≠ticas

POR CATEGOR√çA:
- SYSTEM: Notificaciones del sistema
- MASCOTA: Relacionadas con mascotas
- USER: Relacionadas con usuarios
- SECURITY: Seguridad y accesos
- VETERINARY: Informaci√≥n veterinaria
- OTHER: Otras categor√≠as


7.2 EVENTOS QUE GENERAN NOTIFICACIONES
--------------------------------------

AUTENTICACI√ìN:
‚úì Login exitoso (usuario)
‚úì Login con reconocimiento facial exitoso
‚úì Registro de biometr√≠a facial
‚úì Cambio de contrase√±a

MASCOTAS:
‚úì Mascota registrada exitosamente
‚úì Mascota editada
‚úì Mascota eliminada
‚úì Biometr√≠a de mascota registrada
‚úì Biometr√≠a de mascota eliminada
‚úì Mascota reportada como perdida
‚úì Mascota encontrada (alguien la escane√≥)
‚úì Mascota reconocida en scanner

SISTEMA:
‚úì Bienvenida al sistema (primer login)
‚úì L√≠mite de mascotas alcanzado
‚úì C√≥digo QR generado
‚úì Carnet descargado

ALERTAS:
‚úì Mascota perdida en el sistema (notificaci√≥n a todos)
‚úì Tu mascota fue encontrada (con ubicaci√≥n)


7.3 VISUALIZACI√ìN DE NOTIFICACIONES
-----------------------------------

UBICACI√ìN:
- Icono de campana en navbar (esquina superior derecha)
- Badge con n√∫mero de no le√≠das
- Panel desplegable al hacer clic

ELEMENTOS DE CADA NOTIFICACI√ìN:
- Icono seg√∫n tipo
- T√≠tulo
- Mensaje
- Timestamp (hace X minutos/horas/d√≠as)
- Estado: le√≠da/no le√≠da
- Link de acci√≥n (opcional)
- Imagen relacionada (opcional - ej: foto de mascota)

INTERACCIONES:
‚úì Clic en notificaci√≥n ‚Üí Marca como le√≠da + Redirige a acci√≥n
‚úì Bot√≥n "Marcar todas como le√≠das"
‚úì Bot√≥n individual "Marcar como le√≠da"
‚úì Bot√≥n "Eliminar notificaci√≥n"
‚úì Scroll infinito si hay muchas

PERSISTENCIA:
- Se almacenan en base de datos
- Permanecen hasta que el usuario las elimine
- No caducan autom√°ticamente


7.4 NOTIFICACIONES POR EMAIL (SOLO CASOS ESPEC√çFICOS)
-----------------------------------------------------

El sistema env√≠a emails solo en estos casos:

1. MASCOTA REPORTADA COMO PERDIDA:
   - Destinatarios: TODOS los usuarios del sistema
   - Asunto: "üö® Alerta: [Nombre mascota] ha sido reportada como perdida"
   - Contenido:
     * Foto de la mascota
     * Nombre y descripci√≥n
     * Ubicaci√≥n donde se perdi√≥
     * Datos de contacto del propietario
     * Caracter√≠sticas especiales

2. MASCOTA ENCONTRADA:
   - Destinatario: Propietario de la mascota
   - Asunto: "‚úÖ ¬°Alguien encontr√≥ a [Nombre mascota]!"
   - Contenido:
     * Coordenadas GPS donde fue encontrada
     * Timestamp del encuentro
     * Informaci√≥n del dispositivo (IP, navegador)
     * Link al mapa (si disponible)

3. RECUPERACI√ìN DE CONTRASE√ëA:
   - Destinatario: Usuario solicitante
   - Token de recuperaci√≥n


================================================================================
8. CERRAR SESI√ìN
================================================================================

URL: /logout/
M√©todo: GET o POST

PROCESO:
- Invalida sesi√≥n actual
- Borra tokens de autenticaci√≥n
- Limpia cookies
- Redirecci√≥n a p√°gina de login

MENSAJE:
"Has cerrado sesi√≥n correctamente"


================================================================================
9. MEDIDAS DE SEGURIDAD GENERALES
================================================================================

9.1 RATE LIMITING (L√çMITES DE INTENTOS)
---------------------------------------

| Operaci√≥n                    | L√≠mite       | Per√≠odo |
|------------------------------|--------------|---------|
| Detectar rostro facial       | 30 intentos  | Minuto  |
| Registrar biometr√≠a usuario  | 10 intentos  | Hora    |
| Login facial                 | 10 intentos  | Minuto  |
| Eliminar biometr√≠a usuario   | 5 intentos   | Hora    |
| Login tradicional            | 5 intentos   | 15 min  |
| Solicitar reset de password  | 3 intentos   | Hora    |

Exceder l√≠mites resulta en bloqueo temporal


9.2 VALIDACIONES DE ARCHIVOS
----------------------------

IM√ÅGENES DE PERFIL:
- Formatos: JPG, JPEG, PNG, WEBP
- Tama√±o m√°ximo: 5 MB
- Validaci√≥n de tipo MIME
- Verificaci√≥n de contenido real

FOTOS BIOM√âTRICAS:
- Tama√±o m√≠nimo: 50x50 p√≠xeles
- Confianza m√≠nima: 70%
- Solo 1 rostro permitido


9.3 PROTECCI√ìN CSRF
-------------------
- Tokens CSRF en todos los formularios
- Validaci√≥n en cada POST request
- Timeout de tokens: 1 hora


9.4 PASSWORDS
-------------
- Hashing: PBKDF2 con SHA256
- Salt √∫nico por usuario
- Iteraciones: 216,000
- No se almacenan en texto plano

================================================================================
FIN DE PARTE 1 - AUTENTICACI√ìN Y USUARIOS
================================================================================

SIGUIENTE DOCUMENTO: MANUAL_USUARIO_PARTE2_MASCOTAS_Y_FUNCIONALIDADES.txt
Contendr√°:
- Registro de mascotas
- Predicci√≥n con IA
- Biometr√≠a de mascotas
- Scanner
- QR y carnets
- Mascotas perdidas
- Dashboard
